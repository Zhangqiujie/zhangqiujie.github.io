---
title: MySQL - 初步认识
description: 
author: zhang
date: 2025-11-27 11:33:00 +0800
categories: [MySQL, MySQL是怎样运行的 - 笔记]
tags: [MySQL, Reading Notes]
pin: false
math: true
mermaid: true
---

## MySQL 服务端/客户端架构

MySQL是服务端+客户端架构，通常使用过程是：
1. 启动服务器程序
2. 启动一个`mysql`客户端程序并连接到服务器
3. 在客户端程序中输入一些命令语句作为请求发送到服务器程序，服务器程序收到这些请求后，会根据请求的内容来操作具体的数据并向客户端返回操作结果。

## MySQL的安装

**Unix系统下安装mysql**

```shell
brew install mysql
```

**安装目录**

一般安装后， `mysql`的主文件夹在 `/usr/local/mysql`。

主要的可执行文件都放在`/usr/local/mysql/bin`。可以在`~/.zshrc`里把这个文件夹加入到`PATH`里:

```shell
export PATH=/usr/local/mysql/bin:$PATH
```

这样现在不论我们所处的工作目录是啥，我们都可以直接输入可执行文件的名字就可以启动它，比如这样：

```shell
mysqld
```


## 启动MySQL服务器程序

在类UNIX系统中用来启动MySQL服务器程序的可执行文件有很多，大多在MySQL安装目录的bin目录下。

**mysqld**

`mysqld`这个可执行文件就代表着MySQL服务器程序，运行这个可执行文件就可以直接启动一个服务器进程。

**mysqld_safe**

`mysqld_safe`是一个启动脚本，它会间接的调用`mysqld`，而且还顺便启动了另外一个监控进程，这个监控进程在服务器进程挂了的时候，可以帮助重启它。另外，使用`mysqld_safe`启动服务器程序时，它会将服务器程序的出错信息和其他诊断信息重定向到某个文件中，产生出错日志，这样可以方便我们找出发生错误的原因。

### 生产环境上启动
- 在 容器化部署（Docker / Kubernetes）中，通常直接运行 `mysqld`，让容器的 `restart` 策略负责重启。
- 对于 传统 VM / 物理机，`systemd` + `mysqld` 才是线上生产的标准做法。

## 启动MySQL客户端程序

在我们成功启动`MySQL`服务器程序后，就可以接着用`mysql`命令启动客户端程序来连接到这个服务器。启动这个可执行文件时一般需要一些参数，格式如下(-p和密码间不能有空格)：

```shell
mysql -h主机名  -u用户名 -p密码
```

| 参数名 | 含义 |
|-------|--|
|    -h     | 表示服务器进程所在计算机的域名或者 IP 地址，如果服务器进程就运行在本机，可以省略，或者填 localhost/127.0.0.1。也可以写作 --host=主机名。 |
|    -u     | 表示用户名，也可以写作 --user=用户名。 |
|     -p     | 表示密码，也可以写作 --password=密码。 |
|     -P | 指定端口号 |

## 客户端与服务器连接的过程
运行着的服务器程序和客户端程序本质上都是计算机上的一个进程，所以客户端进程向服务器进程发送请求并得到回复的过程本质上是一个进程间通信的过程！MySQL支持下边三种客户端进程和服务器进程的通信方式。

### TCP/IP
MySQL采用TCP作为服务器和客户端之间的网络通信协议。在网络环境下，每台计算机都有一个唯一的IP地址，如果某个进程有需要采用TCP协议进行网络通信方面的需求，可以向操作系统申请一个端口号，这是一个整数值，它的取值范围是0~65535。这样在网络中的其他进程就可以通过IP地址 + 端口号的方式来与这个进程连接，这样进程之间就可以通过网络进行通信了。

MySQL服务器启动的时候会默认申请3306端口号。

### 命名管道和共享内存 （了解）
如果你是一个Windows用户，那么客户端进程和服务器进程之间可以考虑使用命名管道或共享内存进行通信。

### Unix域套接字文件（了解）
如果我们的服务器进程和客户端进程都运行在同一台操作系统为类Unix的机器上的话，我们可以使用Unix域套接字文件来进行进程间通信。


## 服务器处理客户端请求

MySQL的使用过程是客户端发送一段SQL文本给服务端，服务器进程处理后再向客户端进程发送一段文本（处理结果）。大概的处理过程过程如下图：
![1](/assets/images/1.png)

### 连接管理
每当有一个客户端进程连接到服务器进程时，服务器进程都会创建一个线程来专门处理与这个客户端的交互，当该客户端退出时会与服务器断开连接，服务器并不会立即把与该客户端交互的线程销毁掉，而是把它缓存起来，在另一个新的客户端再进行连接时，把这个缓存的线程分配给该新客户端。这样就**起到了不频繁创建和销毁线程的效果，从而节省开销**。

### 解析与优化
MySQL服务器收到了文本形式的请求，还需要经过以下几个步骤。

#### 查询缓存 （MySQL 8.0 已经废弃）
MySQL会把已经收到的请求和结果记录下来，当下次收到一样请求（需要SQL文本一模一样，例如：空格、注释、大小写）的时候，会命中缓存，直接返回。

虽然查询缓存有时可以提升系统性能，但也不得不因维护这块缓存而造成一些开销。

有任何关于某个表的结构或者数据更新时，该表的所有高速缓存查询都将变为无效并从高速缓存中删除。在`MySQL` 8.0中删除。

#### 语法解析
因为客户端程序发送过来的请求只是一段文本而已，所以`MySQL`服务器程序首先要对这段文本做分析。从文本中将要查询的表、各种查询条件都提取出来。

#### 查询优化
`MySQL`的优化程序会对我们的语句做一些优化，如外连接转换为内连接、表达式简化、子查询转为连接等等。

优化的结果就是生成一个执行计划，这个执行计划表明了应该使用哪些索引进行查询，表之间的连接顺序是啥样的。

我们可以使用`EXPLAIN`语句来查看某个语句的执行计划。

### 存储引擎
MySQL服务器把数据的存储和提取操作都封装到了一个叫`存储引擎`的模块里。

为了管理方便，人们把`连接管理`、`查询缓存`、`语法解析`、`查询优化`这些并不涉及真实数据存储的功能划分为`MySQL server`的功能，把真实`存取数据`的功能划分为`存储引擎`的功能。

所以在`MySQL server`完成了查询优化后，只需按照生成的`执行计划`调用底层存储引擎提供的API，获取到数据后返回给客户端就好了。

## 常用存储引擎

|存储引擎 |描述 |
|--|--|
|InnoDB |具备外键支持功能的事务存储引擎 , MySQL默认引擎|
|MyISAM |主要的非事务处理存储引擎|

## 创建表时指定存储引擎
```
CREATE TABLE 表名(
    建表语句;
) ENGINE = 存储引擎名称;
```
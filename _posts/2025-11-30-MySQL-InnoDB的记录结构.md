---
title: MySQL - InnoDB的记录结构
description: 
author: zhang
date: 2025-11-30 11:33:00 +0800
categories: [MySQL, MySQL是怎样运行的 - 笔记]
tags: [MySQL, Reading Notes]
pin: false
math: true
mermaid: true
---

## InnoDB页简介

`InnoDB`是一个将表中的数据存储到磁盘上的存储引擎。真正处理数据的过程是发生在内存中的，所以需要把磁盘中的数据加载到内存中。InnoDB采取的方式是：将数据划分为若干个页，以页作为磁盘和内存之间交互的基本单位，**InnoDB中页的大小一般为 16 KB**。也就是在一般情况下，一次最少从磁盘中读取16KB的内容到内存中，一次最少把内存中的16KB内容刷新到磁盘中。

## InnoDB行格式

InnoDB存储引擎设计了4种不同类型的行格式，分别是`Compact`、`Redundant`、`Dynamic`和`Compressed`。

### 指定行格式的语法

```
CREATE TABLE 表名 (列的信息) ROW_FORMAT=行格式名称
    
ALTER TABLE 表名 ROW_FORMAT=行格式名称
```

### Compact行格式

![3](/assets/images/3.png)

一条完整的记录其实可以被分为**记录的额外信息**和**记录的真实数据**两大部分。

#### 记录的额外信息

信息分为3类，分别是**变长字段长度列表**、**NULL值列表**和**记录头信息**。

##### 变长字段长度列表

MySQL支持一些变长的数据类型，比如VARCHAR(M)、VARBINARY(M)、各种TEXT类型。用这些类型并且当实际存储不是NULL时，会在头部存储当前实际数据的长度。
存储的顺序和列的顺序相反。
例如：

【 06 02 03 | NULL值列表 | 记录头信息 】【'abc', 'ab', NULL, 'cdsewq'】

这个例子里，每一个列的长度用一个字节（2位十六进制）表示就够。但是InnoDB在这个方面有自己的规则：
我们首先声明一下W、M和L的意思：

1. 假设某个字符集中表示一个字符最多需要使用的字节数为W，比方说utf8字符集中的W就是3，gbk字符集中的W就是2，ascii字符集中的W就是1。
2. 对于变长类型VARCHAR(M)来说，这种类型表示能存储最多M个字符（注意是字符不是字节），所以这个类型能表示的字符串最多占用的字节数就是M×W。
3. 假设它实际存储的字符串占用的字节数是L。

规则是：
1. 如果M×W <= 255（字节），那么使用1个字节来表示真正字符串占用的字节数。
2. 如果M×W > 255（字节），则分为两种情况：
    1.1 如果L <= 127（字节），则用1个字节来表示真正字符串占用的字节数。
    1.2 如果L > 127（字节），则用2个字节来表示真正字符串占用的字节数。

*表中所有的列都不是变长的数据类型的话，这一部分就不需要有。*

##### NULL值列表

某些列可能存储NULL值，如果把这些NULL值都放到记录的真实数据中存储会很占地方，所以Compact行格式把这些值为NULL的列统一管理起来，存储到NULL值列表中。规则和处理过程：
1. 只统计可以放 NULL 的列，排除例如：主键，`Not Null`修饰的列。如果表中没有允许存储 NULL 的列，则 NULL值列表 也不存在了。
2. 在二进制位中逆序表示：
- 二进制位的值为1时，代表该列的值为NULL。
- 二进制位的值为0时，代表该列的值不为NULL。
3. MySQL规定NULL值列表必须用整数个字节的位表示，如果使用的二进制位个数不是整数个字节，则在字节的高位补0。


比如第c1和c3是不能为NULL：
【 02 03 | [00000011] | 记录头信息 】【'abc', NULL, 'dd', NULL】


---
title: MySQL - 字符集和排序规则
description: 
author: zhang
date: 2025-11-29 11:33:00 +0800
categories: [MySQL, MySQL是怎样运行的 - 笔记]
tags: [MySQL, Reading Notes]
pin: false
math: true
mermaid: true
---
## MySQL中支持的字符集和排序规则

### MySQL中的utf8和utf8mb4

utf8字符集表示一个字符需要使用1～4个字节，MySQL 定义了两个概念：

- `utf8mb3`：阉割过的utf8字符集，只使用1～3个字节表示字符。在MySQL中utf8是utf8mb3的别名。
- `utf8mb4`：正宗的utf8字符集，使用1～4个字节表示字符。

### 查看支持的字符集：

```shell
SHOW CHARSET LIKE '%utf8%';
SHOW CHARACTER SET LIKE '%utf8%';
+---------+---------------+--------------------+--------+
| Charset | Description   | Default collation  | Maxlen |
+---------+---------------+--------------------+--------+
| utf8mb3 | UTF-8 Unicode | utf8_general_ci    |      3 |
| utf8mb4 | UTF-8 Unicode | utf8mb4_0900_ai_ci |      4 |
+---------+---------------+--------------------+--------+
2 rows in set (0.00 sec)
```

`Default collation`列表示这种字符集中一种默认的比较规则。
`Maxlen`代表该种字符集表示一个字符最多需要几个字节。

### 比较规则的查看

```shell
mysql> SHOW COLLATION LIKE 'utf8\_%';
+--------------------------+---------+-----+---------+----------+---------+
| Collation                | Charset | Id  | Default | Compiled | Sortlen |
+--------------------------+---------+-----+---------+----------+---------+
| utf8_general_ci          | utf8    |  33 | Yes     | Yes      |       1 |
| utf8_bin                 | utf8    |  83 |         | Yes      |       1 |
| utf8_unicode_ci          | utf8    | 192 |         | Yes      |       8 |
| utf8_icelandic_ci        | utf8    | 193 |         | Yes      |       8 |
......
```
utf8字符集默认的比较规则就是utf8_general_ci。ci表示不区分大小写。
utf8_general_ci是一种通用的比较规则。utf8_polish_ci表示以波兰语的规则比较。

## 字符集和比较规则的应用

### 各级别的字符集和比较规则

MySQL有4个级别的字符集和比较规则，分别是：

- 服务器级别
- 数据库级别
- 表级别
- 列级别

#### 服务器级别

使用`系统变量` `character_set_server` `collation_server`来设置服务器级别的字符串和比较规则。
```shell
SET [GLOBAL/SESSION] character_set_server = utf8
SET [GLOBAL/SESSION] collation_server = utf8_general_ci
```

#### 数据库级别

创建/修改数据库字符集：

```
CREATE/ALTER DATABASE charset_demo_db
    CHARACTER SET gb2312
    COLLATE gb2312_chinese_ci;
```

查看某个数据库的字符集：

```shell
mysql> USE charset_demo_db;
Database changed

mysql> SHOW VARIABLES LIKE 'character_set_database';
+------------------------+--------+
| Variable_name          | Value  |
+------------------------+--------+
| character_set_database | gb2312 |
+------------------------+--------+
1 row in set (0.00 sec)

mysql> SHOW VARIABLES LIKE 'collation_database';
+--------------------+-------------------+
| Variable_name      | Value             |
+--------------------+-------------------+
| collation_database | gb2312_chinese_ci |
+--------------------+-------------------+
1 row in set (0.00 sec)
```

#### 表级别

创建/修改表的字符集：

```
CREATE/ALTER TABLE t(
    col_1 VARCHAR(10)
) CHARACTER SET utf8 COLLATE utf8_general_ci;
```

#### 列级别

对于存储字符串的列，同一个表中的不同的列也可以有不同的字符集和比较规则。
```
CREATE TABLE 表名(
    列名 字符串类型 [CHARACTER SET 字符集名称] [COLLATE 比较规则名称],
    其他列...
);

ALTER TABLE 表名 MODIFY 列名 字符串类型 [CHARACTER SET 字符集名称] [COLLATE 比较规则名称];
```

#### 仅修改字符集或仅修改比较规则
由于字符集和比较规则是互相有联系的，如果我们只修改了字符集，比较规则也会跟着变化，如果只修改了比较规则，字符集也会跟着变化，具体规则如下：

- 只修改字符集，则比较规则将变为修改后的字符集默认的比较规则。
- 只修改比较规则，则字符集将变为修改后的比较规则对应的字符集。

不论哪个级别的字符集和比较规则，这两条规则都适用。

### MySQL请求过程中字符集的转换

从发送请求到返回结果这个过程中伴随着多次字符集的转换，在这个过程中会用到3个系统变量：

|系统变量	|描述|
|----------|---|
|character_set_client|	服务器解码请求时使用的字符集|
|character_set_connection|	服务器处理请求时会把请求字符串从character_set_client转为character_set_connection|
|character_set_results|	服务器向客户端返回数据时使用的字符集|

![2](/assets/images/2.png)

需要注意的地方：
- 服务器认为客户端发送过来的请求是用character_set_client编码的。
- 服务器将把得到的结果集使用character_set_results编码后发送给客户端。
- character_set_connection只是服务器在将请求的字节串从character_set_client转换为character_set_connection时使用。
- 在和具体列的字符对比时，如果列的字符集和character_set_connection的字符集不一致，还要再进行转换。

### 比较规则的应用

主要体现在 `ORDER BY` 上。

***本章思维导图***：

```markmap
# MySQL 字符集与排序规则

## utf8 与 utf8mb4
- utf8 表示字符占用 1～4 字节
- MySQL 中两种定义：
  - utf8mb3：阉割版 utf8，1～3 字节（utf8 别名）
  - utf8mb4：标准 utf8，1～4 字节

### 查看支持的字符集
- 命令：
  - SHOW CHARSET LIKE '%utf8%';
  - SHOW CHARACTER SET LIKE '%utf8%';
- 字段说明：
  - Charset：字符集名称
  - Description：字符集描述
  - Default collation：默认排序规则
  - Maxlen：字符最大字节数

### 查看比较规则
- 命令：
  - SHOW COLLATION LIKE 'utf8\_%';
- 说明：
  - utf8_general_ci：默认规则，不区分大小写
  - utf8_polish_ci：波兰语比较规则
  - ci = case insensitive，不区分大小写

## 字符集和比较规则的级别
- MySQL 支持 4 个级别：
  1. 服务器级别
  2. 数据库级别
  3. 表级别
  4. 列级别

### 服务器级别
- 系统变量：
  - character_set_server：服务器字符集
  - collation_server：服务器排序规则
- 设置方法：
  SET [GLOBAL/SESSION] character_set_server = utf8;
  SET [GLOBAL/SESSION] collation_server = utf8_general_ci;

### 数据库级别
- 创建/修改数据库字符集：
  CREATE/ALTER DATABASE charset_demo_db
      CHARACTER SET gb2312
      COLLATE gb2312_chinese_ci;
- 查看数据库字符集：
  SHOW VARIABLES LIKE 'character_set_database';
  SHOW VARIABLES LIKE 'collation_database';

### 表级别
- 创建/修改表字符集：
  CREATE/ALTER TABLE t(
      col_1 VARCHAR(10)
  ) CHARACTER SET utf8 COLLATE utf8_general_ci;

### 列级别
- 创建列时指定字符集与比较规则：
  CREATE TABLE 表名(
      列名 字符串类型 [CHARACTER SET 字符集] [COLLATE 排序规则],
      ...
  );
- 修改列：
  ALTER TABLE 表名 MODIFY 列名 字符串类型 [CHARACTER SET 字符集] [COLLATE 排序规则];

### 仅修改字符集或排序规则
- 规则：
  - 只修改字符集 → 排序规则变为该字符集默认
  - 只修改排序规则 → 字符集变为该排序规则对应的字符集
- 适用所有级别

## 请求过程中的字符集转换
- 关键系统变量：
  - character_set_client：服务器解码请求使用的字符集
  - character_set_connection：服务器处理请求时，将请求从 client 转为 connection
  - character_set_results：服务器返回数据时使用的字符集
- 流程：
  1. 客户端发送请求 → character_set_client 编码
  2. 转换为 character_set_connection 进行处理
  3. 返回结果 → character_set_results 编码发送
  4. 与列比较时，如果列字符集与 connection 不一致，需要再转换

## 排序规则应用
- 主要用于 ORDER BY
- 不同比较规则会影响字符串排序方式
- ci = 不区分大小写，cs = 区分大小写

```